---
title: "R Notebook"
output:
  html_document:
    df_print: paged
    toc: true
---



```{r}
library(tidyverse)
library(gridExtra)
library(cowplot)
library(fastDummies)
library(factoextra)
library(cluster)
library(dplyr)
```


#  Analisis exploratorio de datos

```{r, warning=F, echo=F, include=F}
datos = read.csv("base_trabajo_segmentacion.csv", sep=";") 
```

```{r, echo=F}
verTablaResumenPorCategoria <- function(df, titulo, titulosColumnas)
{
  tablaResumen <- df[, order(colSums(df), decreasing = T)] %>%
                  colSums() %>% 
                  format(scientific = F, big.mark = ",") %>%
                  knitr::kable(caption = titulo, col.names = titulosColumnas )
  return(tablaResumen)
}

obtenerTotalPorCategoria <- function(df)
{
  totalPorCategoria <- colSums(df)
  return(totalPorCategoria)
}

obtenerTotalPorCategoriaEnPorcentajes <- function(df)
{
  total <- obtenerTotalPorCategoria(df)
  totalPorCategoriaEnPorcentaje <- total/sum(total) * 100
  totalPorCategoriaEnPorcentaje <- round(totalPorCategoriaEnPorcentaje, 2)
  return(totalPorCategoriaEnPorcentaje)
}


crearAnalisisDescriptivoDeTickets <- function () 
{
  return(0)
}

```


## Analisis variables númericas

### Analisis descriptivo del valor promedio de los tickets de entrada


```{r}
# Arregla el nombre de las columnas para que se muestren con un mejor nombre en las tablas y graficos
valorPromedioTicketEntrada <-  datos[grep("en_vm.*", names(datos))] %>% 
                               setNames(c("Canal 1",
                                          "Canal 2",
                                          "Canal 3",
                                          "Canal 4",
                                          "Canal 5",
                                          "Canal 6",
                                          "Canal 7",
                                          "Canal 8",
                                          "Canal 9",
                                          "Canal 10",
                                          "Otros canales"))
```


```{r}
tablaResumenTicketPromedioDeEntrada <- verTablaResumenPorCategoria(valorPromedioTicketEntrada, "Valor promedio del ticket de entrada por canal", c("ValorTotalPorCanales"))
tablaResumenTicketPromedioDeEntrada
```





```{r}
#Total por porcentaje en cada canal
knitr::kable(obtenerTotalPorCategoriaEnPorcentajes(valorPromedioTicketEntrada), caption="Porcentaje de ingresos por canal", col.names="Porcentaje por canal")
```




### Analisis de transacciones promedio por canal


```{r}
# Arregla el nombre de las columnas para que se muestren con un mejor nombre en las tablas y graficos
transaccionesPromedioPorCanal <-  datos[grep("en_tx.*", names(datos))] %>% 
                               setNames(c("Canal 1","Canal 2",
                                          "Canal 3","Canal 4",
                                          "Canal 5","Canal 6",
                                          "Canal 7","Canal 8",
                                          "Canal 9","Canal 10",
                                          "Otros canales"))
```

```{r}
tablaResumenTicketPromedioDeEntrada <- verTablaResumenPorCategoria(transaccionesPromedioPorCanal, "Transacciones promedio de entrada por canal", c("Valor total por canal"))
tablaResumenTicketPromedioDeEntrada
```





```{r}
knitr::kable(obtenerTotalPorCategoriaEnPorcentajes(transaccionesPromedioPorCanal), caption="Porcentaje de transacciones por canal", col.names="Porcentaje por canal")
```



### Valor del ticket promedio de salida

```{r}
# Arregla el nombre de las columnas para que se muestren con un mejor nombre en las tablas y graficos
valorTicketPromedioSalida <-  datos[grep("sal_vm.*", names(datos))] %>% 
                               setNames(c("Canal 5","Canal 2",
                                          "Canal 8","Otros canales"))
```


```{r}
tablaResumenTransaccionesDeSalida <- verTablaResumenPorCategoria(valorTicketPromedioSalida, "Valor promedio del ticket de salida por canal", c("ValorTotalPorCanales"))
tablaResumenTransaccionesDeSalida
```






```{r}
knitr::kable(obtenerTotalPorCategoriaEnPorcentajes(valorTicketPromedioSalida), caption="Porcentaje de ingresos por canal", col.names="Porcentaje por canal")
```




### Transacciones promedio anuales de salida  


```{r}
# Arregla el nombre de las columnas para que se muestren con un mejor nombre en las tablas y graficos
transaccionesPromedioDeSalida <-  datos[grep("sal_tx.*", names(datos))] %>% 
                               setNames(c("Canal 5","Canal 2",
                                          "Canal 8","Otros canales"))
```


```{r}
verTablaResumenPorCategoria(transaccionesPromedioDeSalida, "Transacciones promedio de salida", "Dinero total de salida")
```




```{r}

knitr::kable(obtenerTotalPorCategoriaEnPorcentajes(transaccionesPromedioDeSalida), caption="Porcentaje de valor mensual por canal", col.names="Porcentaje por canal")
```







### Comparación de trafico por cada canal



```{r}
# Obtener los porcentajes por cada tipo de ticket
porcentajePorTicketDeEntrada <- obtenerTotalPorCategoriaEnPorcentajes(valorPromedioTicketEntrada)
porcentajePorTransaccionesPromedioEntrada <- obtenerTotalPorCategoriaEnPorcentajes(transaccionesPromedioPorCanal)
porcentajePorTicketDeSalida <- obtenerTotalPorCategoriaEnPorcentajes(valorTicketPromedioSalida)
porcentajePromedioDeSalida <- obtenerTotalPorCategoriaEnPorcentajes(transaccionesPromedioDeSalida)
```

```{r}
# Ajustar los nombres de los tickets de salida
porcentajePorTicketDeSalida <-  data.frame(canal = c("Canal 5", "Canal 2", "Canal 8", "Otros canales"),
                                           porcentajePorTicketDeSalida=porcentajePorTicketDeSalida)
porcentajePromedioDeSalida <-  data.frame(canal = c("Canal 5", "Canal 2", "Canal 8", "Otros canales"),
                                          porcentajePromedioDeSalida=porcentajePromedioDeSalida)
```

```{r}
# Ajustar los nombres de los tickets de entrada
infoCanalesPorcentajes <- data.frame(canal = c("Canal 1","Canal 2",
                            "Canal 3","Canal 4",
                            "Canal 5","Canal 6",
                            "Canal 7","Canal 8",
                            "Canal 9","Canal 10",
                            "Otros canales"))
infoCanalesPorcentajes$porcentajePorTicketDeEntrada = porcentajePorTicketDeEntrada
infoCanalesPorcentajes$porcentajePorTransaccionesPromedioEntrada = porcentajePorTransaccionesPromedioEntrada
```

```{r}
#Unir todos los porcentajes en un solo dataFrame
infoCanalesPorcentajes <- left_join(infoCanalesPorcentajes, porcentajePorTicketDeSalida, by="canal") 
infoCanalesPorcentajes <- left_join(infoCanalesPorcentajes, porcentajePromedioDeSalida, by="canal") 
infoCanalesPorcentajes <- infoCanalesPorcentajes %>%  mutate(across(everything(), .fns = ~replace_na(.,0))) 
```

```{r}
knitr::kable(infoCanalesPorcentajes, col.names = c("Canal", "Porcentaje por ticket de entrada", "Porcentaje por transacciones mensuales de entrada",
                                                   "Porcentaje por ticket de salida", "Porcentaje por transacciones de salida"))
```




```{r}
# Grafica de porcentaje de transacciones por categoria
ggplot(data=reshape2::melt(infoCanalesPorcentajes, id.vars = "canal"), aes(x=canal, y=value, fill=variable)) +
  geom_bar(width = 0.7, stat="identity", position=position_dodge()) + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
  labs(title="Porcentaje de dinero por cada categoria por cada canal", x="Canales", y="Porcentaje") 
  #coord_flip()
```





##  Variables categoricas

```{r, warning=F, echo=F, include=F}

datos = read.csv("base_trabajo_segmentacion.csv", sep=";") 
```

```{r}
# Funcion para crear una nueva columna con el porcentaje de las transacciones que ese cliente genera 
calcularTotalPorFilas <- function(df, regexColumnas, nombreColumnaTotal, nombreColumnaPorcentajes)
{
  dataFrameConTotalYPorcentajes <- df %>% mutate(
                                              ColumnaTotal = rowSums(select(.,contains(regexColumnas))),
                                              ColumnaPorcentajes= ColumnaTotal/sum(ColumnaTotal)*100
                                          ) 
  colnames(dataFrameConTotalYPorcentajes)[which(names(dataFrameConTotalYPorcentajes) == "ColumnaTotal")] <- 
    nombreColumnaTotal
  colnames(dataFrameConTotalYPorcentajes)[which(names(dataFrameConTotalYPorcentajes) == "ColumnaPorcentajes")] <- 
    nombreColumnaPorcentajes
                                          
  return(dataFrameConTotalYPorcentajes)
}
```


```{r}
# Calcular los porcentajes para cada tipo de ticket
datosConPorcentajesYTotales <-  datos %>% 
  calcularTotalPorFilas("en_vm", "total_tickets_de_entrada_cliente", "porcentaje_de_tickets_de_entrada_cliente") %>%
  calcularTotalPorFilas("en_tx", "total_transacciones_de_entrada_cliente", "porcentaje_transacciones_de_entrada_cliente") %>%
  calcularTotalPorFilas("sal_vm", "total_tickets_de_salida_cliente", "porcentaje_tickets_de_salida_cliente") %>% 
  calcularTotalPorFilas("sal_tx", "total_transacciones_de_salida_cliente", "porcentaje_transacciones_de_salida_cliente") 
```


```{r}
# Genera un dataFrame donde compara el top 80% con el resto 
resumenVariableCategoricaComparada <- function(dfMayoria, dfMinoria, columna)
{
    resumenDeMayoria <- dfMayoria %>%
      count(.dots=columna) %>%
      mutate(n = n/sum(n) * 100)
    
    resumenDeMinoria <- dfMinoria %>%
      count(.dots=columna) %>%
      mutate(n = n/sum(n) * 100)
    
    resumenComparativo <- resumenDeMayoria %>% inner_join(resumenDeMinoria, by= structure(names=columna, .Data=columna))
    return(resumenComparativo)
}
```



```{r}
# Se sacan los 300 mejores clientes que es la cantidad que genera el 80% de las transacciones
clientesQueGeneranLaMayoriaTicketsEntrada <- datosConPorcentajesYTotales %>%
                               filter(total_tickets_de_entrada_cliente != 0)  %>%  
                               arrange(desc(total_tickets_de_entrada_cliente)) %>%
                               head(n=300)
clientesQueGeneranMenorTicketsEntrada <- datosConPorcentajesYTotales %>%
                               filter(total_tickets_de_entrada_cliente != 0)  %>%  
                               arrange(desc(total_tickets_de_entrada_cliente)) %>%
                               slice(301: n())
```




```{r}
# Se escogen nombres que sean mas entendibles para el que lee el reporte
nombresLegibles <- c("Importaciones categorizadas", "Exportaciones categorizadas",
                     "Cuentas por pagar", "Cuentas por cobrar",
                     "Valor de inventarios", "Ventas fisicas", 
                     "Ventas electronicas", "Rotacion de inventarios",
                     "Rotacion de cuentas de pagar", "Rotacion de cuentas por cobrar",
                     "Ciclo de negocio", "Ciclo financiero"
                     )
names(nombresLegibles) <- c("impo_cv", "expo_vt", 
                            "cxp", "cxc", 
                            "totalinventory", "tiene_ventas_fisicas",
                            "tiene_ventas_electronicas", "rotacion_inventarios",
                            "rotacion_cxc", "rotacion_cxp", 
                            "ciclo_negocio", "ciclo_financiero"
                            )
```


```{r}
# Grafica los datos de una columna seleccionada
graficar_datos <- function (df, columnaDf, nombreMasLegible)
{
  titulo <- sprintf("Porcentaje de %s para cada subgrupo", nombreMasLegible)
  etiquetaMayoria <- sprintf("%s mayoria", nombreMasLegible)
  etiquetaMinoria <- sprintf("%s minoria", nombreMasLegible)
  datos <- reshape2::melt(df, id.vars=columnaDf)
  grafico <- ggplot(data=datos, aes(x=.data[[columnaDf]], y=value, fill=variable)) +
          geom_bar(stat="identity", position="stack") + 
          scale_fill_discrete(name = nombreMasLegible, labels = c(etiquetaMayoria, etiquetaMinoria)) +
          labs(title=titulo, x=nombreMasLegible, y="Porcentaje") + 
          theme(legend.position = "top")
  return(grafico) 
  
}

```


## Analisis clientes con mas tickets de salida



```{r}
# Con 500 clientes se genera el 80% de tickets de salida
clientesQueGeneranLaMayoriaTicketsSalida <- datosConPorcentajesYTotales %>%
                               filter(total_tickets_de_salida_cliente != 0)  %>%  
                               arrange(desc(total_tickets_de_salida_cliente)) %>%
                               head(n=500)

clientesQueGeneranMenorTicketsSalida <- datosConPorcentajesYTotales %>%
                               filter(total_tickets_de_salida_cliente != 0)  %>%  
                               arrange(desc(total_tickets_de_salida_cliente)) %>%
                               slice(501: n())
```


```{r}

listaDeVariablesCategoricas <- list()
# Compara las variables categoricas
for (columna in names(nombresLegibles))
{
  datosColumna <- resumenVariableCategoricaComparada(clientesQueGeneranLaMayoriaTicketsSalida, 
                                     clientesQueGeneranMenorTicketsSalida, columna)
  grafico <- graficar_datos(datosColumna, columna, nombresLegibles[[columna]])
  listaDeVariablesCategoricas <- c(listaDeVariablesCategoricas, list(grafico))
}

```

```{r}
# Acceder a la variable que necesitas con la variable listaDeVariablesCategoricas
# con doble llaves cuadradadas [[]] y el indice que necesitas
plot(listaDeVariablesCategoricas[[1]]#<- asi
)
```

```{r}
# Asi puedes hacer una cuadricula con variables un subconjunto de variables
# Con la notacion de llaves cuadradas escoges donde empezar y terminar
# [1,6] Elementos del 1 al 6 
do.call(grid.arrange, c(listaDeVariablesCategoricas[1:6], nrow = 2))
```



#  Segmentacion jerarquica



```{r}


data<-read.table("base_trabajo_segmentacion.csv",sep = ";",header = TRUE)
data<-na.omit(data)

#Modificando las variables
datos_reducidos=mutate(data, en_vm_otros_ = en_vm_canal6+en_vm_canal7+en_vm_canal8+en_vm_canal9+en_vm_canal10+en_vm_otros,en_tx_otros_=en_tx_canal6+en_tx_canal7+en_tx_canal8+en_tx_canal9+en_tx_canal10+en_tx_otros)




borrar <- c("nit","en_vm_canal6","en_vm_canal7","en_vm_canal8","en_vm_canal9","en_vm_canal10","en_vm_otros","en_tx_canal6","en_tx_canal7","en_tx_canal8","en_tx_canal9","en_tx_canal10","en_tx_otros")
datos2 <- datos_reducidos[ , !(names(datos_reducidos) %in% borrar)]#En este paso se eliminan las variables sumadas ateriormente

datos_categoricos_seleccionados=datos2[19:34]#Se seleccionan y almacenan los datos categóricos

datos_categoricos=c("impo_cv","expo_vt","cxp","cxc","totalinventory","pagos_pj","pagos_pn","tiene_ventas_fisicas","tiene_ventas_electronicas","recaudos_pj","recaudos_pn","rotacion_inventarios","rotacion_cxc","rotacion_cxp","ciclo_negocio","ciclo_financiero")

datos_numericos <- datos2[ , !(names(datos2) %in% datos_categoricos)]#Para hacer los primeros análisi se dejan únicamente las variables cuantitativas del modelo
```

```{r}
# Descomposicion espectral
Sigma_t<-cov(scale(datos_numericos,center=T,scale=T))
descomp_espectr_t<-eigen(Sigma_t)
lambdas_t<-descomp_espectr_t$values
D_t<-descomp_espectr_t$vectors
```

```{r}
#En caso de ser necesario, se hará un análisis del ACP
acprincipales=prcomp(datos_numericos,scale=T)
```

```{r}
#Qué % de variablidad es explicada para cada componente:
prop_varianza <- acprincipales$sdev^2 / sum(acprincipales$sdev^2)
prop_varianza*100
```


```{r}
# Grafica de varianza acumulada 
prop_varianza_acum <- cumsum(prop_varianza)

ggplot(data = data.frame(prop_varianza_acum, pc = 1:20),
       aes(x = pc, y = prop_varianza_acum, group = 1)) +
  geom_point() +
  geom_line() +
  theme_bw() +
  labs(x = "Componente principal",
       y = "Prop. varianza explicada acumulada")
```


```{r, warning=F, echo=F}
# Visualizacion de datos con PCA 
datos_proyectados = acprincipales$x

grupo = read.csv("SegmentacionJerarquica.csv", sep=";")  %>% select(grupo)
grupo = grupo %>% mutate(grupo = as.factor(grupo))
#grupo = as.vector(grupo)
PC1 = datos_proyectados[,1]
PC2 = datos_proyectados[,2]
PC3 = datos_proyectados[,3]
#cbind(grupo, pC)

plotly::plot_ly( x=~PC1, y=~PC2, z=~PC3, color=grupo$grupo )
```

#  Analisis segmentacion jerarquica

Para analizar apropiadamente a los clientes, tendremos que observar su comportamiento
en dos categorias:

* Las variables numericas, en esta categoria podremos encontrar:
  * El valor promedio de entrada/salida del ticket por cada canal
  * Cantidad de transacciones mensuales de entrada/salida por cada canal 
  
* Las variables categoricas, la estratificación de los estados financieros
  * Informacion acerca de las importaciones
  * Informacion acerca de las exportaciones
  * Informacion de las cuentas por cobrar
  * Informacion de las cuentas por pagar
  * Informacion de los ciclos financieros
  * Informacion de los ciclos de negocio

Bajo esas categorias se le dara un identificar patrones compartidos por los
diferentes grupos asignados por la segmentación jerarquica. En total el algoritmo 
ha identificó 4 grupos, que se pueden interpretar como 2 sub-segmentos del top 80% 
de clientes que mas dinero genera a la empresa y el 20% inferior. Los segmentos 
identificados quedan de la siguiente manera:

* Top 80%:
  * Grupo 1: este grupo que mas ingresos genera
  * Grupo 3: este segundo grupo que mas ingresos genera
* El 20% inferior: 
  * Grupo 4: este grupo de esta categoría que mas ingresos genera
  * Grupo 2: este grupo es el que menos ingresos genera

Debido a que el grupo 1 es el que mas ingresos genera y tambien el grupo con el 
que mas se hacen transacciones de salida, este grupo va a predominar en esta 
primera frente a los otros grupos. 



```{r, warning=F, echo=F, include=F}
datos = read.csv("SegmentacionJerarquica.csv", sep=";")
```


## Total por grupo en cada canal

En la siguiente tabla se puede ver el total de dinero generados por los tickets 
por cada canal y grupo. Y a continuación, tambien se encontrarán varios graficos donde
se mostrará el porcentaje de participación de los grupos en cada uno de los canales.



```{r}
# Obtener el total por grupo y canal
totalPorGrupos <- datos %>% group_by(grupo) %>% 
                  summarise(across(everything(), sum))
totalPorGrupos[,1:31] / 10^9
```


```{r, echo=FALSE}
grupo <- c(1,2,3,4)

#Funcion que cambia el nombre a las columnas que cumplan con el REGEX
renombrarColumnas <- function(dataFrame, regexColumnas, nombresNuevos)
{
  return (dataFrame[grep(regexColumnas, names(dataFrame))] %>% 
                               setNames(nombresNuevos))
}

# Calcula el porcentaje en un DataFrame numerico
calcularPorcentajes <- function(dataFrame)
{
  return (dataFrame/ sum(dataFrame) * 100)
}

# Une la columna de grupos al DataFrame
agregarColumnaDeGrupos <- function(dataFrame)
{
  Grupo <- c("Grupo 1", "Grupo 2", "Grupo 3", "Grupo 4")
  return(cbind(Grupo, dataFrame))
}

# Esto era para un experimento. Agrega el tipo de ticket a un DataFrame 
agregarColumnaDeTipoTicket <- function(dataFrame, tipoDeTicket)
{
  return(cbind(dataFrame, tipoDeTicket))
}


# Los nuevos nombres de los canales 
nombresDeCanalesDeEntrada = c("Canal 1", "Canal 2", 
                           "Canal 3", "Canal 4",
                           "Canal 5", "Canal 6",     
                           "Canal 7", "Canal 8",
                           "Canal 9", "Canal 10",
                           "Otros canales")

nombresDeCanalesDeSalida = c("Canal 5","Canal 2", "Canal 8","Otros canales")

# Pone nombres mas legibles a los canales y calcula los porcentajes que genera cada grupo

# Modifica los tickets de entrada
regexTiquetDeEntrada = "en_vm.*"

TiquetsDeEntradaEnPorcentajes <-renombrarColumnas(totalPorGrupos, regexTiquetDeEntrada, nombresDeCanalesDeEntrada) %>%
                                calcularPorcentajes() %>%
                                agregarColumnaDeGrupos()

# Modifica las transacciones de entrada
regexTransaccionesDeEntrada = "en_tx.*"

transaccionesDeEntradaEnPorcentajes <-renombrarColumnas(totalPorGrupos, regexTransaccionesDeEntrada, nombresDeCanalesDeEntrada) %>%
                                calcularPorcentajes() %>%
                                agregarColumnaDeGrupos() 



# Modfica los tiquets de salida
regexTiquetDeSalida ="sal_vm.*"

ticketsDeSalidaEnPorcentajes <-renombrarColumnas(totalPorGrupos, regexTiquetDeSalida, nombresDeCanalesDeSalida) %>%
                                calcularPorcentajes() %>%
                                agregarColumnaDeGrupos() 

# Modifica las transacciones de salida
regexTiquetDeSalida ="sal_tx.*"
transaccionesDeSalidaEnPorcentajes <-renombrarColumnas(totalPorGrupos, regexTiquetDeSalida, nombresDeCanalesDeSalida) %>%
                                calcularPorcentajes() %>%
                                agregarColumnaDeGrupos() 
```




```{r, echo=FALSE}

graficarPorcentajesDeClientesEnCanales <- function  (dataFrame, tipoDeTiquet)
{
  grafica <- ggplot(data=reshape2::melt(dataFrame, id.vars ="Grupo"), aes(x=variable, y=value, fill=Grupo)) + 
            geom_bar(width = 0.7, stat="identity", position="stack") +
            labs(title= paste("Porcentaje de ventas", tipoDeTiquet,  "por cada grupo en cada canal"),
                 x="Canales", y="Porcentaje de clientes") + 
            theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))
  return(grafica)
}
```



```{r, fig.width=15, fig.height=12}
grid.arrange(graficarPorcentajesDeClientesEnCanales(TiquetsDeEntradaEnPorcentajes, "de ticket de entrada"),
             graficarPorcentajesDeClientesEnCanales(transaccionesDeEntradaEnPorcentajes, "de transacciones de entrada"),
             graficarPorcentajesDeClientesEnCanales(ticketsDeSalidaEnPorcentajes, "de tickets de salida"),
             graficarPorcentajesDeClientesEnCanales(transaccionesDeSalidaEnPorcentajes, "de transacciones de salida"),
             ncol = 2
             )
```



### Tickets de entrada 

#### Valor promedio del ticket anual

Para esta categoría podemos ver los canales y los grupos que son mas relevantes.
Podemos ver que el canal 1, 2, 5 y 7 son los canales mas importantes. Y que en 
ellos se agrupa el mas de 90% del valor de todos los tickets. Sin duda es una 
buena decisión seguir invirtiendo en estos canales. Como oportunidades de negocio
se observa que el canal 3, 6 y otros canales generan al rededor del un 8%, que pueden
ser una oportunidad para expandirse a futuro, el canal 6 parece ser un buen prospecto
para los grupos con desempeño mas bajo, ya que si los sumamos logran alcanzar al 
segundo mejor grupo. 

El canal 2 es donde todos llegan a tener una mayor participación en el cual el 
grupo 1 genera 8 billones de pesos, seguido por el 3 que genera 1.2 billones de pesos, 
seguido por el grupo 2 con 753 mil millones de pesos y grupo 4 con 629 mil millones 
de pesos.

A parte del canal anterior donde mas destaca el grupo 1 son en el 5 con un 16.6% del total,
el 1 con el 11.9% del total y el 4 con el 3.4% del total. 



```{r}
TiquetsDeEntradaEnPorcentajes
```

```{r}
 colSums(TiquetsDeEntradaEnPorcentajes[,-1])
```
#### Transacciones promedio mensual 


Los canales 4, 3, 1 y otros son los canales mas importantes para esta categoría.
De nuevo como en el valor de los tickets anuales, hay una canal que predomina, 
en este caso el canal 4 es el que mas transacciones genera agrupando mas del 
50% de las transacciones mensuales. Y los canales 3, 1 y otros agrupan un 10-20% 
de las transacciones cada uno. El único canal que mantiene una gran participación
en ambas categorías es el canal 1 con mas del 10% de participación. Los demas canales
manejan un volumen practicamente nulo. Una oportunidad que vale la pena explorar es
como aumentar el volumen de transacciones mensuales para el canal 2. 

Analizando mas a profundidad el grupo 1 vemos que su participación del total en 
los diferentes canales son: 46%, 15% y 11% en los canales 4,3 y otros respectivamente.
El grupo 3 tiene mayor participación en del: 6%, 3% y 1% en los canales 2, 1 y otros
respectivamente. El grupo 2 y el grupo 4 tienen menos del 3 % de participación total y 
sus canales preferido es son el 1,2 y 3. 

Algo que no se espera es que el canal 2 tiene pocas transacciones mensuales y aun 
así su valor de ticket anual es alto, por lo que parece que son transacciones 
de gran volumen en un periodo corto, tal vez son clientes que compran en una temporada
específica del año y por eso su valor de transacciones mensual no es tan alto. 

Otro caso interesante es el del canal 4 el cual mueve unas transacciones muy altas pero
no tiene un porcentaje de ventas tan alto. Es decir en este canal se recoge dinero 
frecuentemente pero no alcanzan una cuota de mercado tan alto como se espera. Esto
mismo ocurre con los clientes que participan con el canal 3 y otros. 



```{r}
transaccionesDeEntradaEnPorcentajes
```

```{r}
 colSums(transaccionesDeEntradaEnPorcentajes[,-1])
```


```{r}
 rowSums(transaccionesDeEntradaEnPorcentajes[,-1])
```

### Tickets de salida

#### Valor promedio del ticket anual

La gran mayoría de los tickets de salida van al canal 2 y 5 con un 98% de los
tickets totales. El canal 2 tiene el 70% de los tickets y el canal 5 tiene
el 20% de los mismos. Solo en el grupo 1 con los canales 2 y 5 suman al rededor 
de 12 billones de pesos. Y contando la contribución del grupo 3 en estos suman
2 billones de pesos. Para los grupos 2 y 4 tambien hay una preferencia por estos
mismos canales así que hay que estudiar la necesidad de conservar los demas 
canales.

```{r}
ticketsDeSalidaEnPorcentajes
```

```{r}
colSums(ticketsDeSalidaEnPorcentajes[,-1])
```



```{r}
rowSums(ticketsDeSalidaEnPorcentajes[,-1])
```
#### Valor de transacciones promedio mensual 

Las transacciones promedio de salida tienen un gran valor en el canal 2 y el 5
aca podemos ver la participación de los grupos, la cual es una tendencia que 
se repite en todas las variables númericas, el grupo 1 ocupa la gran mayor parte 
seguido por el grupo 3 a este le sigue el grupo 2 y el grupo 4 es el que peor 
desempeño muestra en este tipo de medidas.

En este caso vemos que solo el canal 2 se lleva el 98% de las transacciones mensuales, 
aca vemos el comportamiento que se espera de los clientes con mayor transacción anual,
un alto volumen de transacciones mensuales que se reflejan posteriormente en un valor
de ticket mas grande. Aunque tambien podemos ver que existen varios casos como el del
canal 5 que tiene una alta cuota del valor de los tickets pero con pocas transacciones 
mensuales. 

Analizando el comportamiento dentro del canal principal el grupo 1 en este caso 
se lleva el 61% de las transacciones, el grupo 3 el 16%, el grupo 2 el 13% y el
grupo 4 con el 7%. Valdría la pena analizar que tan necesarios son el canal 8 y 
otros para la compañía ya que generan poco valor.     
 

```{r}
transaccionesDeSalidaEnPorcentajes
```

```{r}
colSums(transaccionesDeSalidaEnPorcentajes[,-1])
```



## Variables categoricas

En esta clasificación tendremos información acerca del flujo de efectivo, es decir
se veran variables que miden la capacidad de una empresa de generar efectivo. Esto 
incluye la información desde que una materia prima es registrada para la venta hasta
que se vende finalmente el producto final y el pago es recibido por la empresa.

De la información que tenemos para evaluar la empresa, tendremos: 

* Impo_cv: nos informa acerca de la frecuencia de la entrega de importaciones
* Expo_vt: nos informa acerca de la frecuencia de la entrega de exportaciones
* cxp: cuentas por pagar, compromisos de pago que la empresa ha adquirido
* rotacion_cxp: rotación cuentas por pagar, indica la cantidad de veces que las 
obligaciones de pago son cumplidas por la empresa
* rotacion_cxc: rotación cuentas por cobrar, indica la cantidad de veces que la
empresa recuada el total de una obligación de pago con otra compañía.
* tiene_ventas_fisicas: 1 para indicar que si tiene ventas fisicas, 0 para 
indicar si no tiene ventas físicas
* tiene_ventas_electronicas: 1 para indicar que tiene ventas electronicas, 0 
para inidicar que no tiene ventas electronicas 
* ciclo_negocio: son los días en que una empresa recibe el pago del producto 
una vez ha pagado al proveedor, pasando por la producción y distribución
* ciclo_financiero: sono los días que una empresa lograr producir un producto, 
una vez se compromete con el proovedor a adquirir el producto, pasando por la
producción y distribución

Se realizará un analisis individual de cada una de las categorías, para explicar
los hallazgos mas importantes. 

```{r}
# Se modifica el DataFrame para cambiar el tipo de dato y graficar facilmente 
datosConFactores <-  datos %>%
  mutate(
    impo_cv = as.factor(impo_cv),
    expo_vt = as.factor(expo_vt),
    cxp = as.factor(cxp),
    cxc = as.factor(cxc),
    totalinventory = as.factor(totalinventory),
    tiene_ventas_fisicas = as.factor(tiene_ventas_fisicas),
    tiene_ventas_electronicas = as.factor(tiene_ventas_electronicas),
    rotacion_inventarios = as.factor(rotacion_inventarios),
    rotacion_cxc = as.factor(rotacion_cxc),
    rotacion_cxp = as.factor(rotacion_cxp),
    ciclo_negocio = as.factor(ciclo_negocio),
    ciclo_financiero = as.factor(ciclo_financiero),
    grupo = as.factor(grupo)
  )%>%
  mutate(
    grupo = fct_recode(grupo, "Grupo 1" = "1", "Grupo 2" = "2", "Grupo 3" = "3", "Grupo 4" = "4")
  )


```


```{r}
# Graficas de variables categoricas por grupo
columnasParaGraficar <- c("impo_cv", "expo_vt", "cxp", "rotacion_cxp",
                          "cxc", "rotacion_cxc","totalinventory",
                          "rotacion_inventarios", "tiene_ventas_fisicas",
                          "tiene_ventas_electronicas", "ciclo_negocio",
                          "ciclo_financiero")

lista <- list()

for (columna in columnasParaGraficar)
{
  p1 <- ggplot(datosConFactores, aes(x=.data[[columna]], fill=grupo)) + 
    geom_bar(aes(y = (..count..)/sum(..count..)), position="stack") + 
    scale_y_continuous(labels=scales::percent)  +
    ylab("Porcentaje")  
  lista <- c(lista, list(p1))
  #plot(p1)
}
```


```{r, fig.width=14, fig.height=12}
do.call(grid.arrange, c(lista[1:6], nrow = 3))
```

### Impo CV

En esta categoría vemos un predominio del grupo 1 en las importaciones especialemente
en el nivel 2, donde alcanza su mayor proporción, eso significa que este tipo de 
cliente suele importar una gran cantidad y con una frecuencia no tan alta. 
Despues tienen gran presencia los grupos 2 y 3 que importan en buena cantidad y
a medida que la cantidad de importaciones aumenta la cuota de estos grupos se
reducen. En último lugar tenemos al grupo 4 que tienen dos subgrupos uno que
importa mucho pero sin tanta frecuencia y otro que trae productos con mucha
frecuencia pero en poca cantidad.

### Expo vt

En las exportaciones se ve que el grupo 1 alcanza una cuota muy amplia y se 
concentra una parte de las exportaciones en la zona media, lo cual siginifica
que suele exportar productos mas frecuentemente que los otros grupos. Los demas
grupos tienen una frecuencia de exportacion que ocupa una proporción pareja
entre los tres grupos frecuentes, lo que es común en estos grupos es que es que 
su nivel de exportación se ubique en la zona media e inferior, eso indica que 
estos grupos no suelen exportar de manera tan intensiva como el grupo 1. 


### cxp 

El grupo 1 tiene muchas cuentas por pagar de gran volumen, vemos que este grupo 
se ubica en el último nivel con una proporción mucho mas grande que los demas, es 
decir que los pedidos que hace a sus proovedores suele ser de un valor muy alto es
raro ver en este grupo que tengan cuentas de valor muy bajo. En cambio los demas
grupos no tienen unas cuentas por pagar como si lo tiene el primer grupo. Ellos 
prefieren tener muchas cuentas por pagar por un valor muy bajo y sus cuentas por
pagar se ubican debajo del nivel intermedio, con una proporción muy alta en el
nivel 2. 

### rotacion_cxp 

Los  grupos muestran un comportamiento muy parecido en este apartado, 
la tendencia es que a medida de que se las rotaciones de cuentas por pagar aumenta
el número de empresas en esa categoría baja. Excepto en dos grupos particulares, el
grupo 1 y 4 los cuales muestran una cantidad de empresas con rotaciones de cuentas 
por pagar altas a comparación de los otros grupos. 

### cxc

El grupo 1 en este apartado muestra que tienen cuentas por cobrar con un valor 
muy alto, la proporción para las cuentas por cobrar se ven mas grandes que las
cuentas por pagar lo cual puede mostrar que aunque tengan muchas cuentas por pagar
con un valor muy alto la cantidad de cuentas por cobrar parecen tener un valor 
equivalente o superior al de las cuentas por pagar. Tal vez en las cuentas por 
cobrar podemos evidenciar porque este grupo tiene un rendimiento en los tickets
de entrada mas grande que los demas. Para los demas grupos tenemos un comportamiento
similar: aumenta la proporción de las cuentas por cobrar hasta la zona media y despues
de ahí cae en picada como se ve dramaticamente con el grupo 4, la mayoría suele tener
mas cuentas por cobrar en el nivel 2 y 3 por lo que podemos decir que no tienen cuentas
por cobrar tan grandes a comparación del grupo 1. 


### Rotación_cxc

En la rotación de cuentas por cobrar podemos ver un comportamiento similar al de las cuentas
por pagar, el grupo 1 tiene proporciones similares para cada uno de los niveles. Los demas
grupos a medida de que la cantidad de rotaciones aumenta la proporción de empresas se reduce
pero en este caso el salto en cada nivel no reduce tan rapidamente la cantidad de empresas,
si no que se reduce en saltos mas pequeños. Un caso especial es el del grupo 4 que mantiene
un nivel parecido en todas las proporciones hasta el nivel 3 y en el último nivel aumenta, así
que este grupo suele cobrar rápidamente sus cuentas y venden frecuentemente por los productos
que ofrecen. 




```{r, fig.width=14, fig.height=12}
do.call(grid.arrange, c(lista[7:12], nrow = 3))
```


### totalInventory

En este apartado, en el inventario total puede estar la clave para entender las
características que hacen financieramente mas importante al grupo 1. En este grupo
suelen estar las compañías con un valor de inventario muy alto se ve que la mayoría
de estas empresas estan ubicadas en el nivel mas alto del inventario total, por lo 
que son compañías con productos que tienen mucho valor. Para los demas grupos vemos
que el valor de inventario suele estar por debajo la media y alcanza un maximo de su 
valor en el nivel 2 y a partir de ese punto se reduce la cantidad de compañías a medida
de que el inventario aumenta. Un caso diferente es el del grupo 4 que sigue la misma 
tendencia de aumentar y despues reducirse, en particular aumenta hasta el nivel 3
y de ahí se redcuce hasta el nivel 5 pero con un repunte en el ultimo nivel, este 
grupo entonces es mas variado y tiene una cantidad de empresas con un valor de inventario 
mas alto que los otros grupos pero en una proporicion de compañías mas bajas en cada nivel.

### rotacion_inventarios

El grupo 1 tiene una rotación de inventarios muy parecida en todos los niveles, 
cabe resaltar que tiene una rotación muy alta en el último nivel, ya que los
otros grupos a medida de que los niveles aumentan sus proporciones van bajando.
Un grupo que no sigue esta tendencia es el grupo 4 que es un grupo cuya 
rotación suel ser alta, su precencia empieza a crecer fuertemente desde el 
nivel 4 y consigue una buena participación hasta el último nivel, así que
estas compañías logran rotar rapidamente su inventario por lo que hay sospechas
de que suelen vender frecuentemente muchos artículos de poco valor a diferencia
del grupo 1 que no puede destacar en su rotación pero el valor de lo que tienen
almacenado es muy grande. 

### Ventas físicas y electrónicas

Todos los grupos no venden electrónicamente, un grupo muy pequeño es el que tiene
este tipo de ventas. Por las ventas físcas, el grupo 1 no suele destaca en cantidad 
en este apartado, la mitad tiene ventas físicas y la otra mitad no tiene.
Aca el grupo 2 y 3 destacan. El grupo 2 son compañías que no tiene ventas físicas, 
ellos generan ingresos a partir de otros canales. El grupo 3 si tiene ventas físicas y 
es ahí donde debe generar ingresos, en ventas de sus propias tiendas.

### Ciclo de negocio 

El primer grupo aumenta la proporción de su participación a partir de arriba del nivel 3
y son compañías que tienen un ciclo de negocio alto, esto significa que toma muchos días 
desde el momento que hacen el pago a un proveedor hasta que reciben el pago, así que sus 
productos son productos que demoran en ser entregados. Para los grupos 2 y 3 vemos que
se comportan de manera muy similar tienen una participación similar que aumenta hasta el nivel 4 y 
apartir de ese punto empiezan a decrecer, esto significa que estos dos grupos demoran 
un tiempo alrededor de la media de estas compañías en cerrar un negocio, son productos que
se entregan mas rápido en comparación al grupo 1. El grupo 4 muestra un comportamiento 
atípico casí todas las empresas se ubican en el maximo nivel, esto significa que 
toma mucho tiempo en completar todo el ciclo de negocio y dado que sus productos no 
son tan valiosos pueda ser que sean compañías que tengan algun cuello de botella en
sus procesos internos. 

### Ciclo financiero

Aca los grupos muestran un comportamiento parecido ya que el ciclo financiero es el
ciclo de negocio agregado con el tiempo desde que se ordena la materia prima. En 
este apartado vemos que se reduce el nivel 4 un poco y aumenta el nivel 1, en este 
ultimo nivel aumenta la participación del grupo 1, 2 y 3, así que algunas compañías 
mejoran su rendimiento cuando se mide con el pedido de proveedores.




```{r}
DfConPagos_pj <- datosConFactores %>% select(grupo, pagos_pj)
DfConPagos_pj <- reshape2::melt(DfConPagos_pj, id.vars="grupo")
ggplot(DfConPagos_pj, aes(x=grupo, y=value, fill=grupo) ) + 
  geom_boxplot() +
  theme(legend.position = "none") + 
  labs(title= "Porcentaje de pagos a personas juridicas por grupo", x="Grupo", y="Porcentaje de pagos a personas juridicas")
```


```{r}
DfConPagos_pn <- datosConFactores %>% select(grupo, pagos_pn)
DfConPagos_pn <- reshape2::melt(DfConPagos_pn, id.vars="grupo")
ggplot(DfConPagos_pn, aes(x=grupo, y=value, fill=grupo) ) + 
  geom_boxplot() +
  theme(legend.position = "none") + 
  labs(title= "Porcentaje de pagos a personas naturales por grupo", x="Grupo", y="Porcentaje de pagos a personas naturales")
```
### Porcentaje de pagos a personas naturales y personas jurídicas

El grupo 1 prefiere hacer negocios con personas naturales ya que tienen una media
un poco por encima de las personas naturales. Para los demas grupos vemos una 
preferencia mas marcada a hacer negocios con las personas jurídicas. 


## Caracterización de grupos 

* Grupo 1: estas son empresas que tienen un valor de inventario muy alto, suelen
importar y exportar mucho mas que los demas, tienen cuentas por pagar y por cobrar
muy grandes, con ciclos de negocios muy largos. El valor de los inventarios y el 
volumen de las cuentas puede ser lo que explique porque esta empresa reciba tanto
dinero de estas compañías y pague tanto dinero a las mismas.

* Grupo 2: este grupo es muy similar al siguiente, son compañías que hacen 
pocas importaciones al año, no tienen exportaciones particularmente grandes, 
tienen muchas cuentas por pagar y cobrar de un valor por debajo de la media, 
un inventario por debajo de la media, tienen un ciclo de negocio que esta 
dentro de la media. Este grupo solo destaca en tener un modelo de negocio 
donde no tiene ventas físicas. 

* Grupo 3: tiene características similares que el grupo 2, la cantidad de importaciones,
exportaciones, inventarios que estan por debajo de la media, tienen cuentas
por pagar, cuentas por cobrar y ciclos de negocio que estan por la media. Este grupo
a diferencia del anterior si tiene ventas físicas.

* Grupo 4: estas empresas importan frecuentemente pero en una proporción baja, exportan
a la misma frecuencia que la media. Tienen cuentas por pagar y por cobrar con valores
por debajo de la media pero se hacen muchas cuentas al año, tienen inventarios por un
valor bajo pero venden rapidamente este inventario, no muestra un tipo de venta favorito
y demoran mucho en completar sus negocios. Estos son negocios que deben tener algún cuello
de botella en la manera que hacen sus negocios.

```{r}
#Test 

nit <- read.csv("base_trabajo_segmentacion.csv", sep=";")$nit
segConIds <- cbind(nit, datos)

anti_join(clientesQueGeneranLaMayoriaTicketsSalida,segConIds[segConIds$grupo==1,], by="nit")  %>% 
anti_join(segConIds[segConIds$grupo==3,], by="nit") #drops all observations in df1 that match in df2


inner_join(clientesQueGeneranLaMayoriaTicketsEntrada,segConIds[segConIds$grupo==1,], by="nit")
inner_join(clientesQueGeneranMenorTicketsEntrada,segConIds[segConIds$grupo==3,], by="nit")

inner_join(clientesQueGeneranMenorTicketsEntrada,segConIds[segConIds$grupo==2,], by="nit")
inner_join(clientesQueGeneranMenorTicketsEntrada,segConIds[segConIds$grupo==4,], by="nit")
```


# Segmentacion K-means

```{r}
datos = read.csv("SegmentacionPCA.csv", sep=";")
```



```{r}
# Se modifica el DataFrame para cambiar el tipo de dato y graficar facilmente 
datosConFactores <-  datos %>%
  mutate(
    impo_cv = as.factor(impo_cv),
    expo_vt = as.factor(expo_vt),
    cxp = as.factor(cxp),
    cxc = as.factor(cxc),
    totalinventory = as.factor(totalinventory),
    tiene_ventas_fisicas = as.factor(tiene_ventas_fisicas),
    tiene_ventas_electronicas = as.factor(tiene_ventas_electronicas),
    rotacion_inventarios = as.factor(rotacion_inventarios),
    rotacion_cxc = as.factor(rotacion_cxc),
    rotacion_cxp = as.factor(rotacion_cxp),
    ciclo_negocio = as.factor(ciclo_negocio),
    ciclo_financiero = as.factor(ciclo_financiero),
    grupo = as.factor(grupo)
  )%>%
  mutate(
    grupo = fct_recode(grupo, "Grupo 1" = "1", "Grupo 2" = "2", "Grupo 3" = "3", "Grupo 4" = "4", "Grupo 5" = "5")
  )


```



```{r}
# Graficas de variables categoricas por grupo
columnasParaGraficar <- c("impo_cv", "expo_vt", "cxp", "cxc", "totalinventory", "tiene_ventas_fisicas",
                          "tiene_ventas_electronicas", "rotacion_inventarios", "rotacion_cxc",
                          "rotacion_cxp", "ciclo_negocio", "ciclo_financiero")

for (columna in columnasParaGraficar)
{
  p1 <- ggplot(datosConFactores, aes(x=.data[[columna]], fill=grupo)) + 
    geom_bar(aes(y = (..count..)/sum(..count..)), position="stack") + 
    scale_y_continuous(labels=scales::percent)  +
    ylab("Porcentaje")  
  plot(p1)
}
```





